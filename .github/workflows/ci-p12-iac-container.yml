name: Security - IaC & Container (P12)

on:
  workflow_dispatch:
  push:
    paths:
      - Dockerfile
      - iac/**
      - security/**
      - .github/workflows/ci-p12-iac-container.yml

jobs:
  p12-security:
    runs-on: ubuntu-latest
    concurrency:
      group: p12-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # -----------------------
      # Prepare evidence directory
      # -----------------------
      - name: Prepare evidence directory
        run: |
          mkdir -p EVIDENCE/P12

      # -----------------------
      # Build image
      # -----------------------
      - name: Build Docker image
        run: |
          docker build -t app:local .

      # -----------------------
      # Hadolint
      # -----------------------
      - name: Run Hadolint
        run: |
          docker run --rm \
            -v $PWD:/work \
            hadolint/hadolint:v2.12.0 \
            hadolint -f json /work/Dockerfile \
            > EVIDENCE/P12/hadolint_report.json

      # -----------------------
      # Checkov (IaC)
      # -----------------------
      - name: Run Checkov
        run: |
          docker run --rm \
            -v $PWD:/work \
            bridgecrew/checkov \
            -d /work/iac \
            -o json \
            --compact \
            > EVIDENCE/P12/checkov_report.json

      # -----------------------
      # Trivy
      # -----------------------
      - name: Run Trivy
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v $PWD:/work \
            aquasec/trivy \
            image app:local \
            --format json \
            --output /work/EVIDENCE/P12/trivy_report.json

      # -----------------------
      # Upload artifacts
      # -----------------------
      - name: Upload P12 evidence
        uses: actions/upload-artifact@v4
        with:
          name: P12_EVIDENCE
          path: EVIDENCE/P12/